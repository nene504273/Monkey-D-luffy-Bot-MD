import { readdirSync, statSync, unlinkSync, existsSync, readFileSync, watch, rmSync, promises as fsPromises } from "fs";
const fs = { ...fsPromises, existsSync };
import path, { join } from 'path';
import ws from 'ws';

let handler = async (m, { conn: _envio, command, usedPrefix, args, text, isOwner }) => {
Â  const isDeleteSession = /^(deletesesion|deletebot|deletesession|deletesesaion)$/i.test(command);
Â  const isPauseBot = /^(stop|pausarai|pausarbot)$/i.test(command);
Â  const isShowBots = /^(bots|sockets|socket)$/i.test(command);

Â  const reportError = async (e) => {
Â  Â  await m.reply(`âš ï¸ OcurriÃ³ un error inesperado, lo siento mucho...`)
Â  Â  console.error(e);
Â  };

Â  switch (true) {
Â  Â  case isDeleteSession: {
Â  Â  Â  const who = m.mentionedJid && m.mentionedJid[0] ? m.mentionedJid[0] : m.fromMe ? conn.user.jid : m.sender;
Â  Â  Â  const uniqid = `${who.split('@')[0]}`;
Â  Â  Â  const dirPath = `./${jadi}/${uniqid}`;

Â  Â  Â  if (!await fs.existsSync(dirPath)) {
Â  Â  Â  Â  await conn.sendMessage(m.chat, {
Â  Â  Â  Â  Â  text: `ðŸš« SesiÃ³n no encontrada. No tienes una sesiÃ³n activa.\n\nCrea una con: ${usedPrefix}serbot` // Simplificando mensaje
Â  Â  Â  Â  }, { quoted: m });
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  if (global.conn.user.jid !== conn.user.jid) {
Â  Â  Â  Â  await conn.sendMessage(m.chat, {
Â  Â  Â  Â  Â  text: `ðŸ’¬ Este comando solo puede usarse desde el Bot Principal.\n\nðŸ”— Accede aquÃ­:\nhttps://api.whatsapp.com/send/?phone=${global.conn.user.jid.split`@`[0]}&text=${usedPrefix + command}&type=phone_number&app_absent=0`
Â  Â  Â  Â  }, { quoted: m });
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  await conn.sendMessage(m.chat, {
Â  Â  Â  Â  text: `ðŸ—‘ï¸ Tu sesiÃ³n como Sub-Bot ha sido eliminada con Ã©xito.`
Â  Â  Â  }, { quoted: m });

Â  Â  Â  try {
Â  Â  Â  Â  fs.rmdir(`./${jadi}/${uniqid}`, { recursive: true, force: true });
Â  Â  Â  Â  await conn.sendMessage(m.chat, {
Â  Â  Â  Â  Â  text: `ðŸŒˆ Â¡Todo limpio! Tu sesiÃ³n ha sido borrada por completo.`
Â  Â  Â  Â  }, { quoted: m });
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  reportError(e);
Â  Â  Â  }
Â  Â  Â  break;
Â  Â  }

Â  Â  case isPauseBot: {
Â  Â  Â  if (global.conn.user.jid == conn.user.jid) {
Â  Â  Â  Â  conn.reply(m.chat, `ðŸš« No puedes pausar el bot principal.\nSi deseas ser un Sub-Bot, contacta con el nÃºmero principal.`, m);
Â  Â  Â  } else {
Â  Â  Â  Â  await conn.reply(m.chat, `ðŸ”• ${botname} ha sido pausada.`, m);
Â  Â  Â  Â  conn.ws.close();
Â  Â  Â  }
Â  Â  Â  break;
Â  Â  }

Â  Â  case isShowBots: {
Â  Â  Â  // Filtra solo las conexiones activas
Â  Â  Â  const users = [...new Set([...global.conns.filter(conn => conn.user && conn.ws.socket && conn.ws.socket.readyState !== ws.CLOSED)])];

Â  Â  Â  // FunciÃ³n para calcular tiempo activo (Se mantiene, es Ãºtil)
Â  Â  Â  const convertirMsADiasHorasMinutosSegundos = (ms) => {
Â  Â  Â  Â  let segundos = Math.floor(ms / 1000);
Â  Â  Â  Â  let minutos = Math.floor(segundos / 60);
Â  Â  Â  Â  let horas = Math.floor(minutos / 60);
Â  Â  Â  Â  let dÃ­as = Math.floor(horas / 24);
Â  Â  Â  Â  segundos %= 60;
Â  Â  Â  Â  minutos %= 60;
Â  Â  Â  Â  horas %= 24;

Â  Â  Â  Â  return [
Â  Â  Â  Â  Â  dÃ­as ? `${dÃ­as} dÃ­a(s)` : '',
Â  Â  Â  Â  Â  horas ? `${horas} hora(s)` : '',
Â  Â  Â  Â  Â  minutos ? `${minutos} minuto(s)` : '',
Â  Â  Â  Â  Â  segundos ? `${segundos} segundo(s)` : '',
Â  Â  Â  Â  ].filter(Boolean).join(', ');
Â  Â  Â  };

Â  Â  Â  // Formato simple: Nombre y NÃºmero (y tiempo activo como detalle)
Â  Â  Â  const listaSubBots = users.map((v, i) =>Â 
`[${i + 1}] ðŸ‘¤ ${v.user.name || 'Sub-Bot'}
Â» NÃºmero: wa.me/${v.user.jid.replace(/[^0-9]/g, '')}
Â» Online: ${v.uptime ? convertirMsADiasHorasMinutosSegundos(Date.now() - v.uptime) : 'Desconocido'}`
Â  Â  Â  )
Â  Â  Â  .join('\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n'); // Separador simple

Â  Â  Â  const finalMessage = listaSubBots.length === 0
Â  Â  Â  Â  ? 'No hay Sub-Bots activos.'
Â  Â  Â  Â  : listaSubBots;

Â  Â  Â  // Mensaje final limpio y directo
Â  Â  Â  const msg = `
ðŸ’¬ Lista de Sub-Bots Activos: ${users.length} Sesiones
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
${finalMessage}
`.trim();

Â  Â  Â  await _envio.sendMessage(m.chat, {
Â  Â  Â  Â  text: msg,
Â  Â  Â  Â  // Se mantiene parseMention solo por si el nombre contiene menciones
Â  Â  Â  Â  mentions: _envio.parseMention(msg) 
Â  Â  Â  }, { quoted: m });
Â  Â  Â  break;
Â  Â  }
Â  }
};

handler.tags = ['serbot'];
handler.help = ['sockets', 'deletesesion', 'pausarai'];
handler.command = [
Â  'deletesesion', 'deletebot', 'deletesession', 'deletesesaion',
Â  'stop', 'pausarai', 'pausarbot',
Â  'bots', 'sockets', 'socket'
];

export default handler;